---
title: "Crypto Report"
author: "Filippo Franchini"
date: "Last update: `r Sys.Date()`"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: true
    extra_dependencies: ["float"]

header-includes:
  - \usepackage{makecell}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \lhead{}
  - \fancyhead[R]{}
  - \fancyhead[C]{Crypto Report (DRAFT) -- \today}
  - \fancyfoot[L]{\begin{minipage}[c]{6cm}Created by Filippo Franchini \\ Senior Technical Advisor \\ filippoweb3 on X/LinkedIn\end{minipage}}
  - \fancyfoot[R]{\begin{minipage}[c]{2cm}\end{minipage}}
  - \pagenumbering{gobble}
  - \pagestyle{fancy}
  - \setlength{\footskip}{35pt}

vignette: >
  %\VignetteIndexEntry{report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
font_size: 11pt
geometry: left=1cm,right=1cm,top=2cm,bottom=3cm
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.pos = "h", 
  out.extra = "",
  dpi = 300
)
```

```{r setup, include = FALSE}
library(knitr)
library(dplyr)
library(CryptoIndicator)
library(kableExtra)
library(ggplot2)
library(patchwork)
library(zoo)
library(quantmod)

devtools::load_all()

start_date <- "2025-01-01"

# On-chain

filter_by_date <- function(data, date_col, start, end) {
    if (is.null(data) || nrow(data) == 0) return(data)
    data[data[[date_col]] >= start & data[[date_col]] <= end, ]
  }

onchain <- result$indicators$onchain
df <- filter_by_date(onchain, "timestamp", start_date, Sys.Date())

# Volatility

vol <- result$indicators$volatility

regime_data <- data.frame(
  date = result$indicators$onchain$timestamp,
  regime = vol$regime
  )

# Create a colored bar plot for regimes
regime_data$color <- case_when(
  regime_data$regime == "Extreme High" ~ "red",
  regime_data$regime == "High" ~ "orange",
  regime_data$regime == "Low" ~ "lightgreen",
  regime_data$regime == "Extreme Low" ~ "green",
  TRUE ~ "gray"
  )

regime_data <- filter_by_date(regime_data, "date", start_date, Sys.Date())

df1 <- data.frame(
      date = onchain$timestamp,
      short_vol = vol$volatility$short * 100,
      medium_vol = vol$volatility$medium * 100
    )
df1 <- filter_by_date(df1, "date", start_date, Sys.Date())

df2 <- data.frame(
      date = onchain$timestamp,
      breakout = vol$signals$vol_breakout,
      compression = vol$signals$vol_compression
    )

    # Create signals plot
    df2$signal <- ifelse(df2$breakout, "Breakout",
                        ifelse(df2$compression, "Compression", "Normal"))
    df2$color <- ifelse(df2$breakout, "red",
                       ifelse(df2$compression, "green", "gray"))
    
df2 <- filter_by_date(df2, "date", start_date, Sys.Date())

# Derivatives

deriv <- result$raw_data$derivatives
df3 <- filter_by_date(deriv$data, "date", start_date, Sys.Date())
df3$positive <- df3$avg_funding_rate > 0

df4 <- data.frame(
      date = deriv$data$date,
      oi_percentile = deriv$oi_percentile * 100,
      funding_percentile = deriv$funding_percentile * 100
    )

#df4 <- filter_by_date(df4, "date", "2025-01-01", Sys.Date())

macro <- result$raw_data$macro
m2_data <- data.frame(
  date = macro$liquidity$m2_us$date,
  m2_yoy = macro$liquidity$m2_yoy * 100)
m2_data <- filter_by_date(m2_data, "date", start_date, Sys.Date())
m2_data <- m2_data[!is.na(m2_data$m2_yoy), ]

dxy <- macro$dollar$dxy
dxy_df <- data.frame(
  date = as.Date(index(dxy)),
  dxy = as.numeric(Cl(dxy)))

dxy_df <- filter_by_date(dxy_df, "date", start_date, Sys.Date())
```

\pagenumbering{arabic}

One Page analysis here

\newpage

```{r, echo=F, fig.height=9, fig.width=8, fig.align="center", warning=FALSE, message=FALSE}
p1 <- ggplot(df, aes(x = timestamp, y = mvrv)) +
      geom_line(color = "darkgray", linewidth = 0.5) +
      geom_hline(yintercept = c(0.7, 0.9, 1.75),
                 linetype = "dashed", color = "red", alpha = 0.5) +
      annotate("rect", xmin = min(df$timestamp), xmax = max(df$timestamp),
               ymin = 0.7, ymax = 0.9, alpha = 0.1, fill = "orange") +
      annotate("text", x = min(df$timestamp), y = 0.65, label = "Extreme Bottom",
               hjust = 0, size = 3, color = "darkgreen") +
      annotate("text", x = min(df$timestamp), y = 1.8, label = "Extreme Top",
               hjust = 0, size = 3, color = "red") +
      labs(title = "MVRV Ratio",
           x = "Date", y = "MVRV") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p2 <- ggplot(df, aes(x = timestamp, y = puell_multiple)) +
      geom_line(color = "darkgray", linewidth = 0.5) +
      geom_hline(yintercept = c(0.7, 2),
                 linetype = "dashed", color = "red", alpha = 0.5) +
      annotate("text", x = min(df$timestamp), y = 0.6, label = "Miner Capitulation",
               hjust = 0, size = 3, color = "darkgreen") +
      annotate("text", x = min(df$timestamp), y = 2.1, label = "Miner Selling",
               hjust = 0, size = 3, color = "red") +
      labs(title = "Puell Multiple",
           x = "Date", y = "Puell Multiple") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p3 <- ggplot(df, aes(x = timestamp, y = nvts)) +
      geom_line(color = "darkgray", linewidth = 0.5) +
      geom_hline(yintercept = c(30, 70),
                 linetype = "dashed", color = "red", alpha = 0.5) +
      annotate("text", x = min(df$timestamp), y = 25, label = "Undervalued",
               hjust = 0, size = 3, color = "darkgreen") +
      annotate("text", x = min(df$timestamp), y = 75, label = "Overvalued",
               hjust = 0, size = 3, color = "red") +
      labs(title = "NVT Ratio",
           x = "Date", y = "NVT") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p4 <- ggplot(regime_data, aes(x = date, y = 1, fill = regime)) +
      geom_tile(height = 0.8) +
      scale_fill_manual(values = c("Extreme High" = "red",
                                   "High" = "orange",
                                   "Low" = "lightgreen",
                                   "Extreme Low" = "green")) +
      labs(title = "Volatility Regimes",
           x = "Date", y = "", fill = "Regime") +
      theme_minimal() +
      theme(axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            plot.title = element_text(hjust = 0.5),
            legend.position = "right",
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p5 <- ggplot(df1, aes(x = date)) +
      geom_line(aes(y = short_vol, color = "Short-term (7d)"), linewidth = 0.5) +
      geom_line(aes(y = medium_vol, color = "Medium-term (30d)"), linewidth = 0.5, linetype = "dashed") +
      scale_color_manual(values = c("Short-term (7d)" = "darkgray",
                                    "Medium-term (30d)" = "red")) +
      labs(title = "Volatility Comparison",
           x = "Date", y = "Annualized Volatility (%)",
           color = "Horizon") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            legend.position = "right",
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p6 <- ggplot(df2, aes(x = date, y = 1, fill = signal)) +
      geom_tile(height = 0.8) +
      scale_fill_manual(values = c("Breakout" = "red",
                                   "Compression" = "green",
                                   "Normal" = "gray")) +
      labs(title = "Volatility Signals",
           x = "Date", y = "", fill = "Signal Type") +
      theme_minimal() +
      theme(axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            plot.title = element_text(hjust = 0.5),
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p7 <- ggplot(df3, aes(x = date, y = avg_funding_rate * 100)) +
      geom_col(aes(fill = positive), alpha = 0.7) +
      geom_hline(yintercept = 0, linetype = "solid") +
      geom_hline(yintercept = c(0.01, 0.05, -0.01),
                 linetype = "dashed", color = "gray50", alpha = 0.5) +
      scale_fill_manual(values = c("TRUE" = "green", "FALSE" = "red")) +
      labs(title = "Funding Rates",
           x = "Date", y = "Funding Rate (%)") +
      theme_minimal() +
      theme(legend.position = "none",
            plot.title = element_text(hjust = 0.5),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9))

p8 <- ggplot(df4, aes(x = date)) +
      geom_line(aes(y = oi_percentile, color = "OI Percentile"), linewidth = 0.5) +
      geom_line(aes(y = funding_percentile, color = "Funding Percentile"),
                linewidth = 0.5, linetype = "dashed") +
      geom_hline(yintercept = c(10, 90), linetype = "dotted", color = "gray50") +
      scale_color_manual(values = c("OI Percentile" = "blue",
                                    "Funding Percentile" = "red")) +
      labs(title = "Percentile Ranks",
           x = "Date", y = "Percentile (%)",
           color = "Metric") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            legend.position = "right",
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9))

p9 <- ggplot(m2_data, aes(x = date, y = m2_yoy)) +
      geom_line(color = "darkgreen", linewidth = 0.5) +
      geom_hline(yintercept = c(0, 5), linetype = "dashed", color = "red") +
      annotate("rect", xmin = min(m2_data$date), xmax = max(m2_data$date),
               ymin = 5, ymax = max(m2_data$m2_yoy, na.rm = TRUE),
               alpha = 0.1, fill = "green") +
      annotate("rect", xmin = min(m2_data$date), xmax = max(m2_data$date),
               ymin = min(m2_data$m2_yoy, na.rm = TRUE), ymax = 0,
               alpha = 0.1, fill = "red") +
      labs(title = "M2 Money Supply Growth",
           x = "Date", y = "YoY % Change") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

p10 <- ggplot(dxy_df, aes(x = date, y = dxy)) +
      geom_line(color = "blue", linewidth = 0.5) +
      geom_hline(yintercept = c(90, 100), linetype = "dashed", color = "red") +
      annotate("rect", xmin = min(dxy_df$date), xmax = max(dxy_df$date),
               ymin = 90, ymax = 100, alpha = 0.1, fill = "orange") +
      labs(title = "US Dollar Index (DXY)",
           x = "Date", y = "DXY") +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5),
            legend.text = element_text(size = 7),       
            legend.title = element_text(size = 7),       
            legend.key.size = unit(0.25, "cm"),           
            legend.spacing.x = unit(0.2, "cm"),
            axis.title.x = element_text(size = 9),
            axis.title.y = element_text(size = 9)) + 
      scale_x_date(
        date_breaks = "6 months",
        date_labels = "%b %Y"
      )

# First create the left and right stacks
left_stack <- p1 / p2 / p3 / p9 / p10
right_stack <- p4 / p5 / p6 / p7 / p8

# Then combine them side by side and apply layout
combined_plot <- (left_stack | right_stack)

# Display the plot
combined_plot

```
